<!DOCTYPE html>
<html>
<head>
    <title>测试交流尬聊</title>
    <link href="Scripts/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        body{
            /*width:1900px;*/
        }
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
        div.panel,p.flip{
            margin:0px;
            padding:5px;
            text-align:center;
            background:#808080;
        }
        div.panel{
            height:120px;
            display:none;
        }
    </style>
</head>
<!--@{
ViewBag.Title = "测试交流尬聊";

}-->
<body>
    <p class="flip">测试聊天室～</p>
    <div class="panel">
        <p>这是一个测试聊天室</p>
        <p>即将增加的功能有：</p>
        <p>查看在线成员等...</p>
    </div>
    <div class="container">
        <!--<input type="text" id="message" />-->
        <span id=localtime></span>
        <input type="text" class="form-control" id="message" placeholder="请输入消息！"><br />
        <button type="button" id="sendmessage" class="btn btn-primary">发送</button>
        <button type="button" id="reconnect" class="btn btn-primary" >重连</button>
        <input type="hidden" id="displayname" />
        <ul id="discussion">
            <li id="showmessage">——————————————</li>
            <li id="systemmsg" hidden></li>
        </ul>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.3.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="https://desktop-7409jjg:9001/signalr/hubs"></script>
	<!-- <script src="https://192.168.113.12:9001/signalr/hubs"></script> -->
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(".flip").click(function () {
            $(".panel").slideToggle("slow");
        })
        function notifyMe(title1, body1) {

            var title = "new message";
            var options = {
                body: body1,
                //icon: "https://192.168.113.12:9001/admin.png"
				icon: "https://desktop-7409jjg:9001/admin.png"
            };

            // Let's check if the browser supports notifications
            if (!("Notification" in window)) {
                if (firstshow === 0) {
                    alert("This browser does not support desktop notification");
                    firstshow = 1;
                }
            }

            // Let's check whether notification permissions have already been granted
            else if (Notification.permission === "granted") {
                // If it's okay let's create a notification
                var notification = new Notification(title1, options);
                notification.onshow = function () {
                    setTimeout(function () {
                        notification.close();
                    }, 5000);
                };
            }

            // Otherwise, we need to ask the user for permission
            else if (Notification.permission != 'denied') {
                Notification.requestPermission(function (permission) {
                    // If the user accepts, let's create a notification
                    if (permission === "granted") {
                        var notification = new Notification(title, options);
                        notification.onshow = function () {
                            setTimeout(function () {
                                notification.close();
                            }, 3000);
                        };
                    }
                });
            }

            // At last, if the user has denied notifications, and you
            // want to be respectful there is no need to bother them any more.
        }
        var chat;
        var firstshow = 0;
        function showLocale(objD) {
            var str, colorhead, colorfoot;
            var yy = objD.getYear();
            if (yy < 1900) yy = yy + 1900;
            var MM = objD.getMonth() + 1;
            if (MM < 10) MM = '0' + MM;
            var dd = objD.getDate();
            if (dd < 10) dd = '0' + dd;
            var hh = objD.getHours();
            if (hh < 10) hh = '0' + hh;
            var mm = objD.getMinutes();
            if (mm < 10) mm = '0' + mm;
            var ss = objD.getSeconds();
            if (ss < 10) ss = '0' + ss;
            var ww = objD.getDay();
            if (ww == 0) colorhead = "<font color=\"#FF0000\">";
            if (ww > 0 && ww < 6) colorhead = "<font color=\"#373737\">";
            if (ww == 6) colorhead = "<font color=\"#008000\">";
            if (ww == 0) ww = "星期日";
            if (ww == 1) ww = "星期一";
            if (ww == 2) ww = "星期二";
            if (ww == 3) ww = "星期三";
            if (ww == 4) ww = "星期四";
            if (ww == 5) ww = "星期五";
            if (ww == 6) ww = "星期六";
            colorfoot = "</font>"
            str = colorhead + yy + "-" + MM + "-" + dd + " " + hh + ":" + mm + ":" + ss + " " + ww + colorfoot;
            return (str);
        }
        $(function () {
            //Set the hubs URL for the connection
            // $.connection.hub.url = "https://192.168.113.12:9001/signalr";
            $.connection.hub.url = "https://desktop-7409jjg:9001/signalr";
            // Declare a proxy to reference the hub.
            chat = $.connection.myHub;

            // Create a function that the hub can call to broadcast messages.
            chat.client.addMessage = function (name, message) {
                if ($('#displayname').val() != name) {
                    notifyMe(name, message);
                }
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                var dateobj = new Date();
                // Add the message to the page.
                //$('#discussion').append('<li><strong>' + encodedName
                //    + '</strong>:&nbsp;&nbsp;' + encodedMsg + '&nbsp;&nbsp;&nbsp;&nbsp;发送时间:' + showLocale(dateobj) + '</li>');
                var newmesggeli = $('<li><strong>' + encodedName + '</strong>:&nbsp;&nbsp;' + encodedMsg + '&nbsp;&nbsp;&nbsp;&nbsp;发送时间:' + showLocale(dateobj) + '</li>');
                newmesggeli.hide();
                newmesggeli.insertAfter($('#showmessage')).fadeIn("3000");
                //$('<li><strong>' + encodedName
                //    + '</strong>:&nbsp;&nbsp;' + encodedMsg + '&nbsp;&nbsp;&nbsp;&nbsp;发送时间:' + showLocale(dateobj) + '</li>').insertAfter($('#showmessage')).fadeIn("3000");
            };
            chat.client.stopClient = function (x) {
                $.connection.hub.stop();
                if (x === 1) {
                    alert('该电脑未进行认证，请联系管理员！');
                    $('#systemmsg').html("该电脑未进行认证，请联系管理员！！");
                }
                if (x === 2) {
                    alert('该电脑已经登陆客户端，请勿重复登陆！');
                    $('#systemmsg').html("该电脑已经登陆客户端，请勿重复登陆！");
                    $('#systemmsg').show();
                }
                $('#reconnect').hide(600);
            }
            // Get the user name and store it to prepend to messages.
            $('#displayname').val(prompt('请输入昵称:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#reconnect').html("连接中..."); 
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
            $.connection.hub.disconnected(function () {
                if ($.connection.hub.lastError) {
                    alert("连接超时，请检查网络状态，错误码：" + $.connection.hub.lastError.message);
                }
                $('#reconnect').html("重连"); 
                $('#reconnect').show(500);
                $('#reconnect').click(function () {
                    $.connection.hub.start()
                })

            });
            $.connection.hub.stateChanged(function (change) {
                var statConversion = { 0: 'connecting', 1: 'connected', 2: 'reconnecting', 4: 'disconnected' };
                if (change.newState === 1) {
                    $('#reconnect').hide(500);
                }
                if (change.newState === 2) {
                    $('#reconnect').html("连接中...");
                    $('#reconnect').show(500);
                }
            })
        });
        function tick() {
            var today;
            today = new Date();
            document.getElementById("localtime").innerHTML = showLocale(today);
            window.setTimeout("tick()", 1000);
        }
        $('#message').keydown(function (e) {
            if (e.keyCode == 13) {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();}
        }); 
        tick(); 
    </script>
</body>
</html>